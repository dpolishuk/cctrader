============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.1, pluggy-1.6.0 -- /home/deepol/work/cctrader/venv/bin/python
cachedir: .pytest_cache
rootdir: /home/deepol/work/cctrader/.worktrees/refactor-src
plugins: asyncio-1.3.0, anyio-4.11.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 48 items

tests/test_confidence.py::test_calculate_technical_score PASSED          [  2%]
tests/test_confidence.py::test_calculate_sentiment_score_positive PASSED [  4%]
tests/test_confidence.py::test_calculate_sentiment_score_inverted_for_short PASSED [  6%]
tests/test_confidence.py::test_calculate_liquidity_score PASSED          [  8%]
tests/test_confidence.py::test_calculate_correlation_score PASSED        [ 10%]
tests/test_confidence.py::test_calculate_final_confidence PASSED         [ 12%]
tests/test_main_loop.py::test_scanner_initialization PASSED              [ 14%]
tests/test_main_loop.py::test_pre_filter_movers_by_volume PASSED         [ 16%]
tests/test_main_loop.py::test_scanner_respects_max_movers_limit PASSED   [ 18%]
tests/test_main_loop.py::test_scan_cycle_with_no_movers PASSED           [ 20%]
tests/test_main_loop.py::test_scan_cycle_with_low_confidence_signal PASSED [ 22%]
tests/test_main_loop.py::test_scan_cycle_executes_high_confidence_signal PASSED [ 25%]
tests/test_main_loop.py::test_scan_cycle_rejects_signal_failing_risk_check PASSED [ 27%]
tests/test_momentum_scanner.py::test_scan_for_movers_identifies_gainers PASSED [ 29%]
tests/test_momentum_scanner.py::test_scan_for_movers_identifies_losers PASSED [ 31%]
tests/test_momentum_scanner.py::test_scan_for_movers_filters_below_threshold PASSED [ 33%]
tests/test_momentum_scanner.py::test_scan_all_symbols PASSED             [ 35%]
tests/test_movers_database.py::test_create_movers_tables PASSED          [ 37%]
tests/test_movers_database.py::test_save_mover_signal PASSED             [ 39%]
tests/test_movers_database.py::test_save_mover_rejection PASSED          [ 41%]
tests/test_paper_trading.py::test_create_portfolio ERROR                 [ 43%]
tests/test_paper_trading.py::test_open_position ERROR                    [ 45%]
tests/test_paper_trading.py::test_risk_validation ERROR                  [ 47%]
tests/test_paper_trading.py::test_circuit_breaker ERROR                  [ 50%]
tests/test_paper_trading.py::test_close_position ERROR                   [ 52%]
tests/test_paper_trading.py::test_portfolio_summary ERROR                [ 54%]
tests/test_paper_trading.py::test_execution_modes ERROR                  [ 56%]
tests/test_prompts.py::test_build_analysis_prompt FAILED                 [ 58%]
tests/test_prompts.py::test_build_reanalysis_prompt PASSED               [ 60%]
tests/test_risk_config.py::test_risk_config_defaults PASSED              [ 62%]
tests/test_risk_config.py::test_confidence_tier_risk_calculation PASSED  [ 64%]
tests/test_risk_config.py::test_correlation_groups PASSED                [ 66%]
tests/test_risk_validator.py::test_validate_all_checks_pass PASSED       [ 68%]
tests/test_risk_validator.py::test_reject_low_confidence PASSED          [ 70%]
tests/test_risk_validator.py::test_reject_max_positions PASSED           [ 72%]
tests/test_risk_validator.py::test_reject_exposure_limit PASSED          [ 75%]
tests/test_risk_validator.py::test_reject_daily_loss_limit PASSED        [ 77%]
tests/test_risk_validator.py::test_reject_correlation_limit PASSED       [ 79%]
tests/test_scanner_bundled_tools.py::test_fetch_technical_snapshot_success FAILED [ 81%]
tests/test_scanner_bundled_tools.py::test_fetch_technical_snapshot_partial_failure FAILED [ 83%]
tests/test_scanner_bundled_tools.py::test_fetch_sentiment_data_success FAILED [ 85%]
tests/test_scanner_bundled_tools.py::test_fetch_sentiment_data_web_search_failure FAILED [ 87%]
tests/test_scanner_config.py::test_scanner_config_defaults PASSED        [ 89%]
tests/test_scanner_config.py::test_scanner_config_from_env PASSED        [ 91%]
tests/test_symbol_manager.py::test_refresh_symbols_filters_usdt_futures PASSED [ 93%]
tests/test_symbol_manager.py::test_refresh_symbols_filters_by_volume PASSED [ 95%]
tests/test_symbol_manager.py::test_get_symbols_returns_cached PASSED     [ 97%]
tests/test_symbol_manager.py::test_should_refresh_logic PASSED           [100%]

==================================== ERRORS ====================================
___________________ ERROR at setup of test_create_portfolio ____________________
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_create_portfolio' requested an async fixture 'test_db', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
_____________________ ERROR at setup of test_open_position _____________________
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_open_position' requested an async fixture 'test_db', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
____________________ ERROR at setup of test_risk_validation ____________________
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_risk_validation' requested an async fixture 'test_db', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
____________________ ERROR at setup of test_circuit_breaker ____________________
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_circuit_breaker' requested an async fixture 'test_db', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
____________________ ERROR at setup of test_close_position _____________________
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_close_position' requested an async fixture 'test_db', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
___________________ ERROR at setup of test_portfolio_summary ___________________
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_portfolio_summary' requested an async fixture 'test_db', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
____________________ ERROR at setup of test_execution_modes ____________________
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
../../venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_execution_modes' requested an async fixture 'test_db', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
=================================== FAILURES ===================================
__________________________ test_build_analysis_prompt __________________________
tests/test_prompts.py:29: in test_build_analysis_prompt
    assert 'perplexity' in prompt.lower()
E   assert 'perplexity' in 'analyze solusdt as a potential long opportunity.\n\ncontext:\n- current momentum: +7.20% in 1h, +5.80% in 4h\n- current price: $145.30\n- 24h volume: $1,200,000,000\n- paper portfolio: $10,000\n- open positions: 2/5\n- current exposure: 15.0%\n\nyour task:\n1. gather multi-timeframe technical analysis (1m, 5m, 15m, 1h, 4h)\n2. analyze market sentiment and detect catalysts using web search\n3. check liquidity and volume quality\n4. assess correlation with btc\n5. calculate confidence score (0-100):\n   - technical alignment: 0-40 points\n   - sentiment: 0-30 points\n   - liquidity: 0-20 points\n   - correlation: 0-10 points\n6. determine if high probability trade (confidence ≥ 60)\n7. if yes, specify entry, stop-loss, take-profit, position size\n\nuse your tools systematically. think step-by-step. show reasoning.\n\nefficiency guidelines:\n- call tools in parallel when possible (multiple independent fetch_market_data calls in one message)\n- do not call the same tool multiple times with identical parameters\n- use multi_timeframe_analysis when available instead of individual fetches\n- verify symbol format once (e.g., try "xanusdt" not "xan") before making multiple calls\n\nimportant: only recommend trades with confidence ≥ 60. be conservative.\n\nfinal step: call submit_trading_signal() with your complete analysis.\nthis is required - include all 10 parameters (confidence, prices, scores, symbol, analysis).\n'
E    +  where 'analyze solusdt as a potential long opportunity.\n\ncontext:\n- current momentum: +7.20% in 1h, +5.80% in 4h\n- current price: $145.30\n- 24h volume: $1,200,000,000\n- paper portfolio: $10,000\n- open positions: 2/5\n- current exposure: 15.0%\n\nyour task:\n1. gather multi-timeframe technical analysis (1m, 5m, 15m, 1h, 4h)\n2. analyze market sentiment and detect catalysts using web search\n3. check liquidity and volume quality\n4. assess correlation with btc\n5. calculate confidence score (0-100):\n   - technical alignment: 0-40 points\n   - sentiment: 0-30 points\n   - liquidity: 0-20 points\n   - correlation: 0-10 points\n6. determine if high probability trade (confidence ≥ 60)\n7. if yes, specify entry, stop-loss, take-profit, position size\n\nuse your tools systematically. think step-by-step. show reasoning.\n\nefficiency guidelines:\n- call tools in parallel when possible (multiple independent fetch_market_data calls in one message)\n- do not call the same tool multiple times with identical parameters\n- use multi_timeframe_analysis when available instead of individual fetches\n- verify symbol format once (e.g., try "xanusdt" not "xan") before making multiple calls\n\nimportant: only recommend trades with confidence ≥ 60. be conservative.\n\nfinal step: call submit_trading_signal() with your complete analysis.\nthis is required - include all 10 parameters (confidence, prices, scores, symbol, analysis).\n' = <built-in method lower of str object at 0x3528f4a0>()
E    +    where <built-in method lower of str object at 0x3528f4a0> = 'Analyze SOLUSDT as a potential LONG opportunity.\n\nContext:\n- Current momentum: +7.20% in 1h, +5.80% in 4h\n- Current price: $145.30\n- 24h volume: $1,200,000,000\n- Paper portfolio: $10,000\n- Open positions: 2/5\n- Current exposure: 15.0%\n\nYour task:\n1. Gather multi-timeframe technical analysis (1m, 5m, 15m, 1h, 4h)\n2. Analyze market sentiment and detect catalysts using web search\n3. Check liquidity and volume quality\n4. Assess correlation with BTC\n5. Calculate confidence score (0-100):\n   - Technical alignment: 0-40 points\n   - Sentiment: 0-30 points\n   - Liquidity: 0-20 points\n   - Correlation: 0-10 points\n6. Determine if HIGH PROBABILITY trade (confidence ≥ 60)\n7. If yes, specify entry, stop-loss, take-profit, position size\n\nUse your tools systematically. Think step-by-step. Show reasoning.\n\nEFFICIENCY GUIDELINES:\n- Call tools in PARALLEL when possible (multiple independent fetch_market_data calls in one message)\n- DO NOT call the same tool multiple times with identical parameters\n- Use multi_timeframe_analysis when available instead of individual fetches\n- Verify symbol format once (e.g., try "XANUSDT" not "XAN") before making multiple calls\n\nIMPORTANT: Only recommend trades with confidence ≥ 60. Be conservative.\n\nFINAL STEP: Call submit_trading_signal() with your complete analysis.\nThis is REQUIRED - include all 10 parameters (confidence, prices, scores, symbol, analysis).\n'.lower
____________________ test_fetch_technical_snapshot_success _____________________
tests/test_scanner_bundled_tools.py:16: in test_fetch_technical_snapshot_success
    with patch('agent.scanner.tools.fetch_market_data_internal') as mock_fetch, \
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'agent'
________________ test_fetch_technical_snapshot_partial_failure _________________
tests/test_scanner_bundled_tools.py:58: in test_fetch_technical_snapshot_partial_failure
    with patch('agent.scanner.tools.fetch_market_data_internal') as mock_fetch, \
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'agent'
______________________ test_fetch_sentiment_data_success _______________________
tests/test_scanner_bundled_tools.py:96: in test_fetch_sentiment_data_success
    with patch('agent.scanner.tools.generate_sentiment_query_internal') as mock_query_fn, \
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'agent'
_________________ test_fetch_sentiment_data_web_search_failure _________________
tests/test_scanner_bundled_tools.py:131: in test_fetch_sentiment_data_web_search_failure
    with patch('agent.scanner.tools.generate_sentiment_query_internal') as mock_query_fn, \
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'agent'
=========================== short test summary info ============================
FAILED tests/test_prompts.py::test_build_analysis_prompt - assert 'perplexity...
FAILED tests/test_scanner_bundled_tools.py::test_fetch_technical_snapshot_success
FAILED tests/test_scanner_bundled_tools.py::test_fetch_technical_snapshot_partial_failure
FAILED tests/test_scanner_bundled_tools.py::test_fetch_sentiment_data_success
FAILED tests/test_scanner_bundled_tools.py::test_fetch_sentiment_data_web_search_failure
ERROR tests/test_paper_trading.py::test_create_portfolio - pytest.PytestRemov...
ERROR tests/test_paper_trading.py::test_open_position - pytest.PytestRemovedI...
ERROR tests/test_paper_trading.py::test_risk_validation - pytest.PytestRemove...
ERROR tests/test_paper_trading.py::test_circuit_breaker - pytest.PytestRemove...
ERROR tests/test_paper_trading.py::test_close_position - pytest.PytestRemoved...
ERROR tests/test_paper_trading.py::test_portfolio_summary - pytest.PytestRemo...
ERROR tests/test_paper_trading.py::test_execution_modes - pytest.PytestRemove...
==================== 5 failed, 36 passed, 7 errors in 1.62s ====================
